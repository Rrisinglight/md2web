> **Тема диплома:** Организация канала связи на основе 4G сети для управления беспилотным летательным аппаратом.
> **Цель:** Разработка и тестирование программного обеспечения для эффективного управления беспилотными летательными аппаратами (БПЛА) через каналы связи, основанные на технологии 4G. На базе одноплатого микрокомпьютера с модемом.

__________________________
**Национальный исследовательский технологический университет МИСиС**
Петрова Юлия Витальевна
**Организация канала связи на основе 4G сети для управления беспилотным летательным аппаратом.**
_ИНСТИТУТ КОМПЬЮТЕРНЫХ НАУК_
_КАФЕДРА ИНФОКОММУНИКАЦИОННЫХ ТЕХНОЛОГИЙ_
_НАПРАВЛЕНИЕ 09.03.02 - ИНФОРМАЦИОННЫЕ СИСТЕМЫ И ТЕХНОЛОГИИ_
Научный  руководитель:
доцент кафедры Автоматизированных систем управления,  кандидат технических наук
Антоненко М.С.
Выпускная квалификационная работа
Москва
2024
____________________________

Исходные данные:
- Одноплатный микрокомпьютер с 4G LTE-модемом
- Беспилотный летательный аппарат
- Программное обеспечение для управления БПЛА
- Стабильная 4G-сеть
- Оборудование для измерения качества сигнала и анализа производительности сети
- Инструменты для сбора и анализа телеметрических данных БПЛА

### Оглавление

1. **Введение**
   - Обоснование актуальности темы
   - Цели и задачи работы

2. **Краткая история развития систем контроля доступа**

3. **Основные принципы контроля доступа**

4. **Современные технологии для контроля доступа**

5. **Анализ компаний, производящих системы контроля доступа**

6. **Самодельные проекты на базе IoT**
   - Дверь в мастерскую FabLab
   - Минусы системы управления доступом в FabLab

7. **Требования к системе**
   - Функциональные требования
   - Нефункциональные требования

8. **Выбор компонентов**
   - Выбор RFID считывателя
   - Выбор замка для системы управления доступом
   - Сравнение библиотек для Telegram-ботов на Python
   - Сравнение дистрибутивов для Raspberry Pi
   - Сравнительная таблица баз данных для IoT проекта

9. **Разработанное решение**
   - Общая схема системы
   - Сборка и монтаж системы управления доступом
   - Архитектура системы

10. **Асинхронность и взаимодействие**
    - Очереди и процессы
    - Асинхронное взаимодействие с Telegram

11. **Схема взаимодействия компонентов**
    - Считывание меток
    - Проверка доступа
    - Управление дверью
    - Управление и мониторинг через Telegram

12. **Основные фичи ботов**
    - Бот для пользователей
    - Бот для администраторов

13. **Заключение**
    - Основные выводы по результатам работы
    - Достижения и рекомендации
    - Перспективы внедрения и направления для дальнейших исследований и развития

14. **Источники**
    - Список литературы
    - Исходные коды программного обеспечения
### Введение

Изначально в ходе моего исследования я стремилась найти способ эффективного управления роем дронов. Для этой цели предполагалось использовать мультиканальный передатчик SBUS. Однако в процессе работы были выявлены существенные ограничения радиоканала, что побудило меня рассмотреть другие технологии. В результате я приняла решение попробовать использовать технологию 4G для организации связи между беспилотными летательными аппаратами (БПЛА) и наземной станцией управления (НСУ).

Структура работы включает в себя:
1. Введение.
2. Обзор литературы и анализ существующих решений.
3. Описание методологии и архитектуры разработанной системы.
4. Разработка программного обеспечения и описание используемых технологий.
5. Тестирование и анализ результатов.
6. Заключение и рекомендации по дальнейшему развитию.

Работа включает в себя детальное описание процесса разработки, тестирования и оптимизации системы управления БПЛА на основе технологии 4G, что позволяет продемонстрировать эффективность предложенного решения и его потенциальные преимущества в различных областях применения.

#### Актуальность темы

Актуальность выбранной темы обусловлена необходимостью повышения надежности и эффективности систем управления БПЛА, особенно в условиях ограниченного радиочастотного спектра и высокой вероятности помех. Использование сети 4G предоставляет более широкие возможности для обеспечения стабильной и быстрой передачи данных, что критично для задач мониторинга, спасательных операций и коммерческого использования дронов. Современные требования к безопасности и оперативности управления также делают данную тему крайне важной для дальнейшего развития беспилотных технологий.

Технология управления дронами по 4G открывает новые возможности для их применения в различных сферах. В сельском хозяйстве дроны могут использоваться для мониторинга посевов, оценки состояния растений и внесения удобрений, что позволяет значительно повысить урожайность. В области геодезии и картографии дроны, управляемые по 4G, обеспечивают точное и оперативное проведение измерений и составление карт местности. В сфере безопасности и спасательных операций данная технология позволяет проводить поиск и спасение людей в труднодоступных районах, оперативно реагировать на чрезвычайные ситуации и контролировать обстановку на местах катастроф. Коммерческое использование дронов, включая доставку товаров и инспекцию инфраструктуры, также становится более эффективным и безопасным благодаря надежной и широко распространённой связи по 4G.

#### История и развитие технологий управления беспилотными летательными аппаратами (БПЛА)

История и развитие технологий управления беспилотными летательными аппаратами (БПЛА) начались с первых экспериментов в конце XIX века. В 1898 году Никола Тесла продемонстрировал беспилотную радиоуправляемую лодку, заложив основы для дальнейших разработок. Во время Первой мировой войны была разработана "Аэро-торпеда Кеттеринга", а во Второй мировой войне активно использовались радиоуправляемые аппараты, такие как немецкая ракета Фау-1 (V-1). В 1950-е годы появились первые радиоуправляемые модели самолетов, что стало значительным шагом в развитии дистанционного управления.

В период холодной войны (1960-е – 1980-е годы) развитие БПЛА продолжалось с акцентом на военное применение. В 1960-е годы были разработаны системы, такие как американский Ryan Firebee, использовавший радиоуправление и автопилот. В 1970-е годы спутниковые технологии начали использоваться для навигации и связи, значительно расширяя возможности управления БПЛА. В 1980-е годы внедрение микропроцессоров улучшило точность и надежность систем управления.

С 1990-х годов начался рост гражданского использования БПЛА. В этот период были разработаны коммерческие и научные приложения для дронов, использовавшие GPS и спутниковую связь. В 2000-е годы наблюдалось бурное развитие технологий, включая более мощные процессоры, улучшенные аккумуляторы и сенсоры. В это время дроны начали активно использоваться в коммерческих целях, таких как картографирование и мониторинг окружающей среды. В 2010-е годы интеграция искусственного интеллекта и машинного обучения позволила создать автономные системы управления, способные выполнять сложные задачи без участия человека. Развитие сетевых технологий, таких как 4G и 5G, обеспечило надежную и быструю передачу данных между БПЛА и наземными станциями управления.

Переход от радиоканалов к 4G/5G может стать ключевым этапом в развитии технологий управления БПЛА. Радиоуправление, используемое в современных системах, ограничивается небольшим радиусом действия, подверженностью помехам. Технологии 4G и 5G предоставляют более широкие возможности, обеспечивая стабильную и быструю передачу данных на большие расстояния. Это критично для задач мониторинга, спасательных операций и коммерческого использования дронов. Высокая пропускная способность и низкая задержка 5G делают возможным управление БПЛА в режиме реального времени с минимальными рисками потери связи.

Однако на сегодняшний день ограничением для использования сетей GSM остается зона покрытия. До полного перехода на 4G/5G еще далеко из-за задержек и сложностей в использовании сетей GSM для контроля за дроном. Также ограничением является высота, на которой могут работать эти сети. Эти факторы продолжают быть значительными препятствиями на пути к полной интеграции технологий мобильной связи в управление БПЛА.

В будущем можно ожидать дальнейшего развития технологий управления БПЛА, особенно в области автономных систем и искусственного интеллекта. Улучшение сетевых технологий, таких как 6G, обеспечит еще большую скорость передачи данных и надежность связи. Дроны будут интегрироваться в различные сферы жизни, от сельского хозяйства и геодезии до логистики и охраны окружающей среды, становясь неотъемлемой частью нашей повседневной жизни.

#### Современные технологии беспроводной связи для БПЛА

Современные технологии беспроводной связи для беспилотных летательных аппаратов (БПЛА) играют ключевую роль в их управлении и выполнении различных задач. Основными способами связи являются радиосвязь, спутниковая связь, сотовая связь (LTE/5G) и Wi-Fi.
##### Радиосвязь
Радиосвязь остаётся одним из наиболее распространённых способов управления БПЛА. Она обеспечивает низкую задержку и высокую надёжность связи на небольших и средних расстояниях. Примеры включают системы на частотах 2.4 ГГц и 5.8 ГГц, которые часто используются для коммерческих и любительских дронов. Для повышения дальности и устойчивости к помехам используются технологии, такие как Frequency Hopping Spread Spectrum (FHSS) и Direct Sequence Spread Spectrum (DSSS).
##### Спутниковая связь
Спутниковая связь применяется для управления БПЛА на больших расстояниях, включая межконтинентальные полёты. Примеры включают использование систем Iridium и Inmarsat, которые обеспечивают глобальное покрытие. Спутниковая связь позволяет передавать данные телеметрии и видеопотока с минимальными задержками, что важно для миссий, требующих высокой точности и надёжности.
##### Сотовая связь (LTE/5G)
Сотовая связь, включая технологии LTE и 5G, активно используется для связи с БПЛА в условиях городской инфраструктуры. Преимущества включают высокую скорость передачи данных и широкое покрытие. Технологии 5G предлагают низкую задержку и возможность подключения большого числа устройств, что важно для применения дронов в логистике и мониторинге.
##### Wi-Fi
Wi-Fi широко используется для беспилотных летательных аппаратов (БПЛА) на небольших расстояниях благодаря высокой скорости передачи данных и доступности. Стандарты Wi-Fi, такие как 802.11n, 802.11ac и 802.11ax, обеспечивают надежную связь, что позволяет передавать видео и данные в реальном времени. Примеры систем включают DJI Lightbridge, Parrot Anafi и Skydio 2, которые используют Wi-Fi для управления и передачи видео. Основные преимущества Wi-Fi — это высокая скорость, широкая доступность и низкая стоимость, хотя его дальность ограничена, и он подвержен помехам, что требует дополнительных мер безопасности.

#### Сравнительный анализ

Технологии связи для управления беспилотными летательными аппаратами (БПЛА) прошли долгий путь развития, начиная с ранних радиоуправляемых систем и заканчивая современными сетями 4G и 5G. Традиционные радиоканалы, такие как CSRF (Crossfire) и ELRS (ExpressLRS), обеспечивают низкую задержку (20-30 мс и 10-20 мс соответственно) и высокую надежность. CSRF может работать на частотах 868 МГц или 915 МГц и имеет дальность действия до 100 км, что делает его идеальным для дальних полетов и критических задач, хотя его пропускная способность ограничена передачей управляющих команд и телеметрии. ELRS также работает на частотах 2.4 ГГц или 900 МГц, достигая дальности до 30 км, и при этом остается экономически доступным, хотя и с ограниченной пропускной способностью.

SBUS, используемый для радиоуправляемых моделей, имеет очень низкую задержку (3-5 мс), но его дальность действия ограничена до 2 км. Он работает на частоте 2.4 ГГц и подходит только для передачи управляющих команд, не поддерживая большие объемы данных. В отличие от радиоканалов, технологии 4G и 5G предлагают значительно более высокую пропускную способность и дальность действия, ограниченную только зоной покрытия сети. 4G-Mavlink, например, обеспечивает задержку в пределах 50-100 мс, работает на частотах LTE (например, 700-2700 МГц) и позволяет передавать не только управляющие команды, но и телеметрию, а также видеопоток в реальном времени, что критично для задач мониторинга и спасательных операций.

Однако использование сетей GSM (3G, 4G, 5G) для управления дронами имеет свои ограничения. Главным из них является зона покрытия: в удаленных районах и на больших высотах связь может быть нестабильной или вовсе отсутствовать. Кроме того, несмотря на высокую скорость передачи данных и низкую задержку в теории, на практике могут возникать значительные задержки из-за перегрузки сети или качества сигнала. Эти факторы продолжают быть значительными препятствиями на пути к полной интеграции технологий мобильной связи в управление БПЛА.

Переход от традиционных радиоканалов к сетям 4G и 5G открывает новые возможности для управления БПЛА, однако требует решения текущих проблем с зоной покрытия и задержками. В будущем можно ожидать дальнейшего развития сетевых технологий, таких как 6G, что обеспечит еще большую скорость передачи данных и надежность связи, делая управление дронами еще более эффективным и безопасным.

##### Сравнительная таблица технологий передачи видео

| Технология | Скорость передачи данных (Мбит/с) | Дальность действия (км) | Задержка (мс) | Качество видео |
| ---------- | --------------------------------- | ----------------------- | ------------- | -------------- |
| Walksnail  | До 100                            | До 5                    | 20-30         | 1080p 60 FPS   |
| DJI O3     | До 200                            | До 10                   | 10-20         | 4K 60 FPS      |
| 4G-RTSP    | До 100                            | Зависит от оператора    | 30-70         | 1080p 30 FPS   |

##### Сравнительная таблица технологий передачи данных по радиоканалу

| Технология | Надежность связи | Дальность действия (км) | Задержка (мс) | Пропускная способность (Мбит/с) |
| ---------- | ---------------- | ----------------------- | ------------- | ------------------------------- |
| CSRF       | Высокая          | До 10                   | 5-10          | 5-10                            |
| ELRS       | Высокая          | До 5                    | 5-10          | 5-10                            |
| SBUS       | Средняя          | До 1                    | 1-2           | 2-3                             |
| 4G-Mavlink | Средняя          | Зависит от покрытия     | 50-100        | 50-100                          |
Использование сети 4G LTE для управления беспилотными летательными аппаратами (БПЛА) предоставляет значительные преимущества, включая увеличенную дальность действия, высокую пропускную способность и сравнительно низкую задержку передачи данных. Однако, ключевым ограничением использования 4G в таких приложениях является неоднородность сетевого покрытия, что потенциально может привести к обрывам связи с БПЛА в отдаленных или плохо покрытых сетью районах. **Эту проблему можно решить путем интеграции 4G с традиционными системами управления и внедрением алгоритмов автономного управления, которые обеспечивают дополнительную надежность и безопасность операций с дронами в условиях нестабильной сетевой связи.**

### Постановка задачи

Цель проекта заключается в разработке и тестировании программного обеспечения для управления беспилотными летательными аппаратами (БПЛА) через 4G связь, с акцентом на обеспечении стабильности системы управления и минимизации задержек в передаче данных. Это особенно важно для оперативного реагирования БПЛА на команды и изменения в окружающей среде.
##### Основные этапы проекта:

1. **Исследование существующих технологий и протоколов**: Анализ и выбор наиболее подходящих методов и протоколов для передачи данных.
2. **Разработка архитектуры системы**: Создание структуры системы передачи данных, оптимизированной для использования в сетях 4G.
3. **Реализация программного обеспечения**: Программирование и настройка ПО для управления БПЛА через 4G-сеть.
4. **Тестирование и оптимизация**: Проверка работы системы на стабильность и задержки, последующая оптимизация для улучшения производительности.
5. **Анализ результатов и рекомендации**: Оценка эффективности системы и разработка предложений по её улучшению.
##### Функциональные требования к системе передачи данных:

- **Стабильный коммуникационный канал с IP-адресацией**: Использование 4G и интернета для обеспечения связи между БПЛА и наземной станцией управления.
- **Передача телеметрических данных**: Отправка данных с полетного контроллера БПЛА, включая координаты ГНСС, скорости, направления и другие критические параметры.
- **Приём управляющих сигналов**: Обработка команд управления от наземной станции и их трансляция на бортовое оборудование.
- **Трансляция видеопотока**: Передача видео с бортовой камеры на наземную станцию для мониторинга и управления.

Эти аспекты необходимы для поддержания производительности и безопасности БПЛА в различных операционных условиях, от коммерческой эксплуатации до чрезвычайных ситуаций.
##### Ожидаемые результаты

В этой работе я бы хотела достичь следующих ключевых показатели при испытаниях системы передачи данных для управления беспилотными воздушными суднами (БПЛА):

1. **Системная интеграция и тестирование коммуникации**:
   - Надёжное установление и поддержание канала связи между БПЛА и наземной станцией управления через сотовую связь и интернет с использованием IP-адресации.
   - Успешное получение и реальное отображение на НСУ телеметрических данных с полётного контроллера БПЛА, включая координаты по ГНСС, вертикальные и горизонтальные скорости, направления по осям, высоту полёта, и напряжение батареи.

2. **Управление и навигация**:
   - Эффективная передача управляющих сигналов от НСУ к БПЛА, позволяющая осуществлять контролируемый пилотируемый полёт на расстояние не менее 1 км от места размещения пилота.
   - Возможность осуществления взлёта и прямолинейного полёта БПЛА на высоту до 300 метров и достижения скорости горизонтального полёта не менее 100 км/ч.

3. **Видеотрансляция**:
   - Передача видеопотока с цифровой видеокамеры на НСУ, обеспечивающая визуальную навигацию и контроль за полётом БПЛА в реальном времени.

Прохождение этих испытаний не говорит, что система полностью готова к эксплуатации во всех возможных условиях. Испытания, хоть и довольно обширные, но не являются максимально жёсткими в смысле проверки всех аспектов системы под экстремальными нагрузками или в критических сценариях эксплуатации. Однако, служат важным доказательством концептуальной жизнеспособности системы. Они позволяют утверждать, что система способна успешно справляться с базовыми задачами и показывают, что она достигла стадии 'proof of concept'. Это указывает на то, что основные функциональные элементы системы работают в соответствии с заявленными требованиями, обеспечивая стабильную и оперативную передачу данных.

Для полной готовности системы к коммерческому внедрению и использованию в чрезвычайных операциях потребуется проведение дополнительных испытаний, включая тесты в различных условиях и сценариях, которые могут включать переменные метеорологические условия, различные уровни радиоинтерференций и другие факторы, способные повлиять на производительность системы.

### **Теоретические основы**

#### Методы исследования и структура работы

Для достижения поставленных целей использовались следующие методы исследования:

- **Анализ литературы и существующих решений** в области беспилотных систем и технологий передачи данных, что позволило сформировать фундаментальное понимание требований и проблематики.
- **Моделирование и симуляция систем управления БПЛА** в виртуальной среде с использованием различных инструментов, что способствовало разработке предварительных концепций и решений.
- **Разработка программного обеспечения** с использованием языков Python и C++, а также настройка и интеграция компонентов системы для обеспечения их совместимости и функциональности.
- **Практические тесты и выезды в поле** для проверки работы гипотез на практике и уточнения параметров системы в реальных условиях эксплуатации. Основной акцент был сделан на этих методах, поскольку они позволяли не только подтвердить теоретические разработки, но и выявить неочевидные проблемы и нюансы, которые могут возникнуть только в условиях реального применения технологий.
- **Оптимизация системы на основе данных**, полученных в ходе тестирования, для улучшения её производительности, надёжности и удобства использования.

Эти методы исследования обеспечили комплексный подход к разработке и валидации системы, учитывая как теоретическую базу, так и практические аспекты эксплуатации БПЛА.

#### Основные принципы работы мобильных сетей 4G

Мобильные сети 4G, также известные как LTE (Long Term Evolution), представляют собой стандарты беспроводной связи, обеспечивающие высокоскоростной доступ в Интернет. Основные принципы работы 4G включают:

1. **OFDMA (Orthogonal Frequency-Division Multiple Access)**: технология мультиплексирования, которая делит широкополосный канал на множество ортогональных подканалов (также называемых субканалами или поднесущими). Каждый подканал может быть выделен разным пользователям, что позволяет передавать данные нескольким устройствам одновременно и более эффективно использовать доступный спектр. Это особенно важно для поддержания высокой пропускной способности и минимизации помех в перегруженных сетях.
2. **MIMO (Multiple Input Multiple Output)**: Технология, которая использует несколько антенн на передающем и приемном концах. Это позволяет увеличить количество параллельных потоков данных, что значительно увеличивает скорость передачи и устойчивость канала к помехам. MIMO может работать в разных режимах, таких как:
- **Spatial multiplexing**, когда разные потоки данных отправляются одновременно через разные антенны, увеличивая скорость передачи.
- **Beamforming**, который фокусирует сигнал на определенном пользователе, улучшая качество связи и увеличивая дальность действия.
3. **IP-базированная архитектура**: В LTE все передачи данных осуществляются на базе IP. Это значит, что каждый передаваемый элемент данных, или пакет, обрабатывается в соответствии с протоколом IP, который определяет как данные маршрутизируются через различные сетевые узлы до конечного получателя.

##### В OSI
В модели OSI LTE охватывает несколько уровней:
- **Физический уровень**: Обработка сигналов, модуляция и демодуляция.
- **Канальный уровень**: Контроль ошибок, управление доступом к среде.
- **Сетевой уровень**: IP-маршрутизация и управление сетевыми ресурсами.

##### Пример передачи пакета
> добавить картинку

Рассмотрим подробный процесс передачи пакета данных от устройства к базовой станции (вышке), в интернет и обратно:

1. **Исходная передача данных**:
    - Пользователь инициирует передачу данных, например, отправляет фотографию по email.
    - Данные делятся на IP-пакеты.
    - Мобильное устройство использует OFDMA для выбора подканала и MIMO для эффективной передачи пакетов к базовой станции.
2. **Обработка на базовой станции**:
    - Базовая станция принимает пакеты и перенаправляет их в сеть оператора через шлюз доступа.
    - Пакеты могут подвергаться агрегации (сборке мелких пакетов в один большой для эффективной передачи) или сжатию (уменьшение размера данных для ускорения передачи).
3. **Передача через интернет**:
    - Пакеты направляются через сеть оператора в интернет.
    - При этом используется маршрутизация IP, где каждый пакет независимо направляется к целевому серверу.
4. **Прием и ответ**:
    - Сервер получает пакеты, обрабатывает их (например, сохраняет фотографию в хранилище email) и отправляет подтверждение об успешном приеме обратно пользователю.
    - Подтверждение также делится на IP-пакеты и передается обратно через интернет и мобильную сеть к устройству пользователя.
5. **Получение подтверждения на устройстве**:
    - Пакеты принимаются устройством, собираются в исходное сообщение о подтверждении, и пользователь видит уведомление о успешной доставке.

##### Категории LTE: подробное описание

Категории LTE (LTE Cat) определяют максимальную скорость передачи данных, которую может поддерживать устройство в различных условиях.

Категории LTE обозначаются цифрой, за которой следует буква. Например, LTE Cat 4, LTE Cat 6, LTE Cat 18. Чем выше число, тем выше максимальная скорость передачи данных. Категория LTE влияет на скорость передачи данных, которую можно получить. Если устройство имеет более высокую категорию LTE, оно может работать быстрее, чем устройство с более низкой категорией, при условии, что сеть поддерживает эту категорию.
###### Расшифровка обозначений
- **LTE Cat**: категория LTE
- **b**: обозначение частотного диапазона (бэнда)
- **Число**: номер частотного диапазона. Например, b3 - это 3-й частотный диапазон.
###### Диапазоны частот LTE
Каждая категория LTE может работать в разных частотных диапазонах, которые называются "бэндами" (bands). Например, LTE Cat 4 может работать в диапазонах b3, b7, b20.
Встречаются частоты в зависимости от региона и оператора. Основные диапазоны включают:
- **b3 (1800 МГц)**: Один из самых распространенных диапазонов, используется для городских и пригородных зон. ~ 150 Мбит/с
- **b1 (2100 МГц)**: Используется для плотных городских зон, обеспечивает высокую пропускную способность. ~ 300 Мбит/с,
- **b8 (900 МГц)**: Обеспечивает лучшее покрытие в сельских и пригородных зонах благодаря лучшему проникновению сигнала в здания. ~ 1 Гбит/с
#### Задержки

Задержки в сетях LTE возникают по следующим причинам:
- **Пропускная способность**: Ограничена числом пользователей и объемом передаваемых данных.
- **Процессинг данных**: Время обработки сигналов и данных на уровнях физического и канального уровня.
- **Сетевые маршруты**: Задержки на сетевом уровне из-за маршрутизации и передачи через промежуточные узлы.
#### Ограничения по высоте и дальности

- **Высота**: Ограничена максимальной высотой антенн и устройств, что обычно не превышает 1-2 км.
- **Дальность**: Зависит от частоты, например, диапазон b8 (900 МГц) имеет большую дальность (до 10-15 км в сельской местности) по сравнению с b1 (2100 МГц) или b3 (1800 МГц).

Таким образом ключевыми параметрами, оказывающими влияние на эффективность использования беспроводных сетей в данной работе, являются **задержки, высота и дальность передачи сигнала**. Важно отметить, что существуют методы для оптимизации каждого из этих параметров. 

Для уменьшения объема передаваемых данных возможна динамическая перенастройка режимов передачи видео и телеметрии. Эффективное сжатие телеметрических данных может быть достигнуто за счет использования алгоритмов кодирования, которые удаляют избыточную информацию, тем самым улучшая скорость и стабильность передачи данных.

Задержки, связанные с маршрутизацией данных через промежуточные узлы, могут быть минимизированы при использовании наземных станций с прямым IP-адресом и развертыванием VPN-серверов на таких станциях, что способствует сокращению количества сетевых хопов (прыжков) и уменьшению числа транзитных узлов, через которые проходят данные. Это приводит к оптимизации пути передачи данных и улучшению его контролируемости.

Увеличение дальности и высоты передачи данных достижимо через применение высокоэффективных модулей передачи и антенн высокого качества. Кроме того, разработка алгоритмов автономного управления способствует повышению надежности и безопасности управления беспилотными летательными аппаратами в условиях изменчивой сетевой инфраструктуры.

### Выбор протоколов и стандартов передачи данных

Для успешной реализации проекта по управлению беспилотными летательными аппаратами (БПЛА) с использованием технологии 4G связи, крайне важно выбрать наиболее подходящие протоколы и стандарты передачи данных. Эффективность этих решений напрямую влияет на стабильность связи, скорость передачи данных и общую надежность системы. В свете этого, основное внимание следует уделить анализу существующих протоколов и стандартов, чтобы обеспечить минимальные задержки, высокую пропускную способность и устойчивость канала связи в различных операционных условиях.

Как мною уже упоминалось, при выборе протокола для управления дроном по 4G необходимо учитывать несколько факторов, таких как:
- **Скорость передачи данных:** Для управления дроном в реальном времени требуется высокая скорость передачи данных.
- **Задержка:** Задержка - это время, которое требуется для передачи данных от пульта управления к дрону и обратно. Низкая задержка критична для обеспечения отзывчивого управления.
- **Надежность:** Протокол должен быть надежным и обеспечивать бесперебойную передачу данных.
- **Безопасность:** Протокол должен быть защищен от взлома, спуфинга и несанкционированного доступа.

### Mavlink

Выбор протокола MAVLink (Micro Air Vehicle Link) для работы с 4G в контексте управления беспилотными летательными аппаратами и передачи телеметрии обусловлен несколькими ключевыми факторами, делающими его идеальным для таких задач:

1. **Бинарный формат**: MAVLink использует бинарный формат сообщений, который более эффективен по сравнению с текстовыми форматами с точки зрения как размера передаваемых данных, так и скорости их обработки. Это снижает задержки и уменьшает нагрузку на сеть, что критично для операций в реальном времени.

2. **Открытый исходный код**: Будучи open-source проектом, MAVLink поддерживает широкую адаптацию и интеграцию со многими полетными контроллерами и платформами. Это облегчает разработку и тестирование, а также позволяет сообществу вносить свои улучшения и расширения в протокол.

3. **Поддержка внешних джойстиков:** Наземные станции, такие как Mission Planner и QGroundControl, интегрируют поддержку внешних джойстиков через протокол MAVLink.

4. **Поддержка множества полётных контроллеров**: MAVLink широко поддерживается различными полетными контроллерами и системами управления, что делает его универсальным выбором для разработчиков БПЛА. Эта широкая поддержка способствует интеграции разнообразного оборудования и программного обеспечения.

5. **Кроссплатформенность**: Протокол поддерживается на множестве платформ, включая популярные операционные системы как настольные, так и мобильные, например Android. Это делает его идеальным для использования в различных приложениях, где требуется управление БПЛА с разных устройств. Программы управления, такие как Mission Planner и QGroundControl, доступны на этих платформах, упрощая запуск и эксплуатацию систем.

MAVLink стал де-факто стандартом в индустрии БПЛА для связи между БПЛА и наземными станциями или другими БПЛА. Это гарантирует высокую степень совместимости и взаимодействия между различными системами и устройствами.

#### Выбор протокола передачи видео и кодека

Это ключевой аспект в системах, где необходима высококачественная и эффективная передача видео, например, в системах видеонаблюдения, стриминговых сервисах и беспилотных летательных аппаратах. Подходящий выбор протокола и кодека зависит от нескольких факторов, включая требуемую пропускную способность, задержки, потерю данных, качество изображения и аппаратные возможности.

##### Протоколы передачи видео

1. **RTMP (Real-Time Messaging Protocol)**: Используется для стриминга в режиме реального времени через Интернет. RTMP поддерживает низкую задержку передачи, что делает его идеальным для живых трансляций, но требует постоянного соединения и высокой пропускной способности.

2. **HLS (HTTP Live Streaming)**: Позволяет передавать потоковое видео через HTTP. HLS делит поток на последовательность небольших файлов, что улучшает устойчивость к изменениям в сети, но вносит дополнительную задержку в передачу.

3. **WebRTC (Web Real-Time Communications)**: Оптимальный выбор для интерактивных приложений, таких как видеоконференции, из-за его способности предоставлять видео и аудио связь в реальном времени с минимальной задержкой.

##### Видеокодеки

1. **H.264/AVC**: Широко используемый кодек, обеспечивающий хорошее соотношение между качеством и размером файла. H.264 эффективно сжимает видео, что снижает требования к пропускной способности и делает его подходящим для различных интернет-приложений.

2. **H.265/HEVC (High Efficiency Video Coding)**: Более новый стандарт, который предлагает лучшее сжатие по сравнению с H.264, тем самым сокращая необходимую пропускную способность вдвое при сохранении того же качества видео. Идеален для высококачественного видеостриминга, особенно в условиях ограниченной пропускной способности.

3. **VP9**: Бесплатный кодек от Google, который предоставляет сравнимое с H.265 качество сжатия, но без лицензионных отчислений. Часто используется в сервисах, таких как YouTube, для снижения нагрузки на сеть при сохранении высокого качества видео.

В контексте выбора подходящего видеокодека и протокола для передачи видео с использованием Raspberry Pi Zero 2W были проведены тесты различных протоколов и кодеков. Из-за аппаратной поддержки на данном устройстве был выбран кодек H.264, который обеспечивает эффективное сжатие видео и поддерживается на аппаратном уровне, включая декодирование MPEG-4 (1080p30) и кодирование H.264 (1080p30).

Для передачи видео был выбран протокол RTMP, который, согласно проведенным испытаниям, показал хорошие результаты на низких битрейтах, сравнимо с WebRTC, однако с более широкой поддержкой на различных платформах. Это делает RTMP более предпочтительным вариантом для данного проекта.

В ходе тестирования был разработан эмулятор плохого сетевого соединения для оценки устойчивости разных протоколов к условиям с низким битрейтом и высокой задержкой. Результаты показали, что при сценариях с высокой задержкой и джиттером (1000 мс задержка, 500 мс джиттер) протоколы, основанные на UDP (как RTMP и WebRTC), показали лучшую производительность, чем TCP. В экстремальных условиях с очень низким битрейтом (128k) все протоколы испытывали значительные трудности, что подчеркивает необходимость внедрения агрессивного управления качеством передачи, такого как фреймдроп на стороне отправителя.

В свете полученных результатов и с учетом аппаратных ограничений Raspberry Pi Zero 2W было решено продолжить использование кодека H.264 с протоколом RTMP для обеспечения наилучшей производительности и совместимости. Рассмотрение возможности транскодирования в VP8 или VP9, хотя и может предложить улучшения в качестве сжатия, требует дополнительных ресурсов и приводит к снижению производительности системы на данном оборудовании, учитывая его аппаратные ограничения. Выбор Pi Zero 2W будет обоснован далее в этой работе.

> Вставить видео

#### WireGuard

Использование VPN в контексте управления дроном по 4G необходимо, когда речь идет о конфигурации с nanoSIM, где существуют сложности с получением белого IP-адреса. VPN позволяет обеспечить безопасное и надежное соединение между дроном и наземной станцией, ограниченную доступность белых IP-адресов, что типично для мобильных сетей. Таким образом, VPN создает виртуальный "прямой" канал связи, игнорируя ограничения NAT и обеспечивая стабильный доступ к управлению дроном из любой точки мира с интернет-соединением.

#### Выбор VPN: WireGuard против OpenVPN и ZeroTier

**WireGuard** является современным, высокопроизводительным VPN-протоколом, который предлагает несколько ключевых преимуществ для управления дронами:

- **Простота конфигурации и использования**: WireGuard требует значительно меньше настроек по сравнению с OpenVPN и ZeroTier. Это упрощает его развертывание и управление.
- **Высокая производительность и низкая задержка**: WireGuard разработан с использованием современных криптографических протоколов, что обеспечивает более высокую производительность и меньшую задержку. Это критично для реального времени управления дронами, где каждая миллисекунда важна.
- **Эффективность на уровне протокола**: WireGuard работает на уровне сетевого интерфейса, а не на уровне приложения (как OpenVPN), что делает его более эффективным с точки зрения потребления ресурсов.

**OpenVPN**, хотя и является проверенным и широко используемым решением, страдает от относительно высокой задержки и большей сложности в настройке. Кроме того, OpenVPN может потреблять больше системных ресурсов, что может быть критичным для устройств с ограниченными возможностями, таких как мобильные устройства или маломощные дроны.

**ZeroTier** предлагает функционал, аналогичный VPN, но ориентирован на создание виртуальных сетей, которые могут включать множество устройств. Хотя это делает ZeroTier мощным инструментом для создания сложных сетевых топологий, для задач управления дроном это может быть избыточным, а также потреблять больше ресурсов по сравнению с WireGuard.

В целом, выбор WireGuard для управления дроном по 4G с nanoSIM предоставляет оптимальное сочетание простоты, производительности и эффективности, что делает его идеальным выбором для обеспечения стабильного и безопасного управления дронами в условиях, где каждая миллисекунда задержки имеет значение.

### Разработка системы управления БПЛА

#### Выбор аппаратной платформы (одноплатный микрокомпьютер, 4G модем)

При выборе одноплатного микрокомпьютера для управления БПЛА мною учитывались следующие критерии:

1. **Форм-фактор и вес**: SoC должен быть компактным и легким, чтобы легко интегрироваться в конструкцию БПЛА без значительного увеличения веса.

2. **Поддержка плат расширения**: Важно, чтобы SoC поддерживал различные платы расширения для увеличения функциональности БПЛА, включая дополнительные модули связи, сенсоры и контроллеры.

3. **Сообщество и поддержка**: SoC должен иметь активное сообщество пользователей и разработчиков, что обеспечивает доступ к широкому спектру ресурсов, включая документацию, примеры кода, и быстрое решение возникающих проблем через обновления и багфиксы.

4. **Видеоинтерфейсы**:
   - **Аналоговый видеовыход**: Наличие аналогового видеовыхода для подключения к внешним видеоприемникам, что позволяет использовать традиционные методы видеотрансляции.
   - **CSI (Camera Serial Interface)**: Необходим интерфейс CSI для подключения камеры высокого разрешения, что позволит проводить съемку в высоком качестве и обрабатывать видеоданные непосредственно на БПЛА.

5. **Производительность**: SoC должен обладать достаточной вычислительной мощностью для обработки задач управления полетом, обработки данных с сенсоров и видео, а также для выполнения сложных алгоритмов в реальном времени.

| Параметр / Модель           | Raspberry Pi Zero 2 W | Banana Pi BPI-M4 Zero | Orange Pi Zero 2W | Radxa ZERO 3W    |
| --------------------------- | --------------------- | --------------------- | ----------------- | ---------------- |
| **Процессор**               | Cortex-A53            | Allwinner H618        | Allwinner H618    | Rockchip RK3566  |
| **Количество ядер/Частота** | 4 ядра / 1.0 GHz      | 4 ядра / 1.5 GHz      | 4 ядра / 1.5 GHz  | 4 ядра / 2.0 GHz |
| **Поддержка CSI**           | Да (через Mini CSI)   | Нет                   | Да (через CSI)    | Да (через CSI)   |
| **Аппаратные кодеки H264**  | Да                    | Да                    | Да                | Да               |
| **Аппаратные кодеки H265**  | Нет                   | Да                    | Да                | Да               |
| **ОЗУ**                     | 512MB                 | 1GB                   | 1GB/2GB/4GB       | 2GB/4GB/8GB      |
| **Wi-Fi**                   | 802.11 b/g/n          | 802.11 b/g/n/ac       | 802.11 b/g/n/ac   | 802.11 b/g/n/ac  |
| **Bluetooth**               | 4.2                   | 4.2                   | 5.0               | 5.0              |
| **Энергопотребление**       | Низкое                | Среднее               | Низкое            | Среднее          |
| **Порты ввода/вывода**      | GPIO 40-пин           | GPIO 40-пин           | GPIO 26-пин       | GPIO 40-пин      |
| **Поддержка сообщества**    | Очень высокая         | Низкая                | Средняя           | Низкая           |
| **Цена**                    | Примерно $15          | Примерно $35          | Примерно $20      | Примерно $50     |
| **Аналоговый видеовыход**   | Да                    | Нет                   | Нет               | Нет              |
| **Вес**                     | ~19г                  | ~28г                  | ~26г              | ~34г             |
Ключевыми факторами в выборе Raspberry Pi Zero 2 W стали активная поддержка сообщества, работающие драйверы для камеры и наличие аналогового видеовыхода. Эти преимущества позволили передавать видео с цифровой камеры, подключенной через CSI, непосредственно на VTX с минимальной, практически незаметной задержкой. Поддержка сообщества гарантирует своевременное обновление и решение возникающих проблем, что делает Raspberry Pi Zero 2 W надежным и удобным в использовании устройством для проектов, требующих качественной и стабильной видеотрансляции.

Была также попытка использовать более мощную Orange Pi Zero 2W, но заставить её корректно работать с CSI камерой стало настоящим испытанием. В итоге никакого прироста от аппаратного энкодера я не заметила, что сделало выбор в пользу Raspberry Pi Zero 2 W ещё более очевидным.

#### Обоснование выбора Waveshare SIM7600G-H 4G HAT

На сегодняшний день на рынке представлено ограниченное количество решений, которые предлагают интеграцию 4G связи для одноплатных микрокомпьютеров, особенно в формате Raspberry Pi Zero 2W. Среди доступных вариантов, Waveshare SIM7600G-H выделяется как практически единственное полноценное решение, специально разработанное для работы с Raspberry Pi Zero 2W. 

#### Преимущества формата HAT

- **Компактность и интеграция**: В отличие от USB-донглов, которые часто громоздкие и неудобные для интеграции в компактные дроны и самолеты, HAT-формат SIM7600G-H идеально подходит для Raspberry Pi Zero 2W, обеспечивая минимальный объем и вес.
- **Выносные антенны**: Waveshare SIM7600G-H оборудован выносными антеннами, которые можно удобно расположить для оптимального приёма сигнала. Это критически важно для обеспечения надежного и стабильного соединения, особенно в условиях переменной географии и динамичных полетов.
- **Эстетика и функциональность**: HAT-модули лучше вписываются в конструкцию дронов и самолетов, обеспечивая более аккуратный и профессиональный вид, в отличие от USB-донглов с их менее эффективными антеннами и неудобной установкой.

#### Технические преимущества

- **Широкий спектр частот**: SIM7600G-H поддерживает множество частотных диапазонов LTE, UMTS и GSM, что обеспечивает гибкость в выборе оператора и возможность работы в различных регионах мира.
  - LTE: B1/B3/B5/B7/B8/B20/B38/B40/B41
  - UMTS: B1/B5/B8
  - GSM: 850/900/1800/1900 МГц
- **Высокая скорость передачи данных**: Модуль обеспечивает скорость загрузки до 150 Мбит/с и выгрузки до 50 Мбит/с, что достаточно для передачи телеметрии, видео и управляющих сигналов в реальном времени.
- **Интегрированный GNSS**: Поддержка GPS, GLONASS, BeiDou и Galileo позволяет использовать модуль для точного позиционирования и навигации, что особенно важно для беспилотных систем.
- 

Waveshare SIM7600G-H 4G HAT является идеальным выбором для использования с Raspberry Pi Zero 2W в проектах управления БПЛА. Ограниченное количество решений на рынке в этом форм-факторе, вместе с техническими преимуществами, делает его лучшим выбором для создания надежной и эффективной системы управления дронами с использованием 4G связи. Выносные антенны обеспечивают отличное качество сигнала, а компактность и эстетичность HAT-формата позволяют интегрировать модуль в конструкцию дрона, обеспечивая при этом максимальную производительность и удобство использования.


### Разработка и настройка программного обеспечения

![[Pasted image 20240607054210.png]]

> Пунктиром обозначены опцианальные части системы
#### Общая схема работы

1. **БПЛА (БВС)**
    - **Радиоприемник БВС**: Принимает сигналы управления по радиоканалу (RCIN, SBUS, CSRF).
    - **Контроллер БВС**: Управляет полетом дрона на основе входящих сигналов.
    - **Сетевые компоненты БВС**: Управляют передачей данных через UART.
    - **Видеопередатчик БВС**: Передает видео сигнал через CVBS.
    
2. **Система передачи данных (СПД)**
    - **Цифровая камера**: Снимает видео и передает его в блок обработки видео.
    - **Блок по работе с видео**: Обрабатывает видеосигнал, переданный с камеры, и отправляет его по протоколу MIPI CSI.
    - **Блок по работе с MAVLink**: Обрабатывает команды управления и телеметрию, поступающие по протоколу MAVLink через UART.
    - **LTE модем и VPN клиент**: Обеспечивает подключение к сети Интернет и настройку VPN для безопасной передачи данных.
    
3. **Наземная станция управления (НСУ)**
    - **Радиоаппаратура НСУ**: Обеспечивает прием и передачу сигналов управления.
    - **ПО НСУ (MissionPlanner)**: Программное обеспечение для управления полетом дрона и мониторинга телеметрии.
    - **Сервер VPN**: Обеспечивает настройку и управление VPN соединениями для передачи данных.
    - **Видеоприемник НСУ**: Принимает видеосигнал от дрона.
##### Протоколы и соединения
- **MIPI CSI**: Протокол передачи видео с цифровой камеры в блок обработки видео.
- **CVBS**: Передача аналогового видеосигнала от видеопередатчика БВС.
- **UART, MAVLink**: Передача данных телеметрии и управляющих команд.
- **Ethernet**: Сетевое соединение для передачи данных между компонентами БВС и СПД.
- **UDP VPN, UDP RTSP**: Протоколы передачи видео и данных через Интернет по защищенному VPN каналу.
- **HID**: Протокол взаимодействия между радиоаппаратурой НСУ и ПО НСУ.

![[modem.jpeg]]
Система передачи данных, подключенная к полётному контроллеру.

### **Алгоритмическая и программная реализации**

Весь мой проект разделён на несколько основных частей, разнесённых по отдельным репозиториям.

#### Настройка Raspberry Pi и его окружения #board

Код в этом репозитории выполняет широкий спектр операций для настройки Raspberry Pi и его окружения. В основном он настраивает параметры загрузки, опции ядра, сетевые настройки, службы, программное обеспечение, конфигурацию VPN, безопасность сети, журналирование событий, графический интерфейс и многое другое. По завершении скрипт перезагружает систему. Он включает различные конфигурационные файлы и скрипты, необходимые для настройки системы, обеспечения связи, управления и мониторинга. Этот скрипт призван автоматизировать и упростить процесс настройки Raspberry Pi. В процессе тестирования, я неоднократно меняла устройства, разбивала дроны, сжигала полётные контроллеры... Каждый раз руками настраивать raspberry крайне затратно по времени, поэтому был рзработан скрипт автонастройки. В будущем это позволит сделать решение опенсорсным, чтобы каждый желающий мог с лёгкостью настроить и сипользовать мою систему.

##### Основные компоненты

1. **config.txt**:
    - Файл конфигурации для Raspberry Pi, который определяет параметры загрузки и работы системы.
    - **Основные параметры**:
        - `camera_auto_detect=0`: Отключение автоматического обнаружения камеры.
        - `dtoverlay=ov5647`: Использование оверлея для камеры ov5647.
        - `disable_fw_kms_setup=1`: Отключение настройки KMS драйвера.
        - `framebuffer_width=720` и `framebuffer_height=576`: Установка разрешения фреймбуфера.
        - `arm_64bit=1`: Включение 64-битного режима.
        - `enable_uart=1`: Включение UART.
        - `dtoverlay=disable-bt`: Отключение Bluetooth.
    - Эти настройки позволяют оптимизировать работу Raspberry Pi для задач управления и передачи данных.

2. **deploy.sh**:
    - Скрипт для развертывания и настройки системы.
    - **Основные функции**:
        - Отключение IPv6.
        - Настройка параметров командной строки для загрузки.
        - Отключение ненужных сервисов и удаление ненужных пакетов для повышения производительности.
        - Установка и настройка Wireguard для создания VPN соединения.
        - Настройка iptables для управления сетевыми правилами.
        - Установка и настройка zram для улучшения производительности системы.
        - Настройка xinit и автозапуска X-сервера для запуска графического интерфейса.
    - Скрипт завершает работу перезагрузкой системы для применения всех изменений.

3. **temp.sh**:
    - Скрипт для мониторинга температуры CPU и GPU.
    - **Основные функции**:
        - Чтение текущей температуры CPU и вывод информации в удобочитаемом формате.
        - Чтение температуры GPU с помощью команды `vcgencmd measure_temp`.
    - Это полезно для мониторинга состояния системы в реальном времени.

4. **journald.conf**:
    - Файл конфигурации для настройки журнала systemd.
    - **Основные настройки**:
        - Настройка параметров ведения журнала для оптимизации производительности системы и управления логами.
    
5. **rules.v4**:
    - Конфигурационный файл для iptables.
    - **Основные правила**:
        - Настройка правил для управления входящими, исходящими и пересылаемыми пакетами.
        - Обеспечение безопасности и управления сетевым трафиком.
    
6. **autologin.conf**:
    - Конфигурационный файл для настройки автоматического входа.
    - Обеспечивает автоматический вход пользователя при загрузке системы.

7. **xinitrc**:
	Требуется для использования пина аналогового видеовыхода.
    - Скрипт для настройки X-сессии.
    - Определяет команды, которые будут выполняться при запуске X-сервера.

9. **wpa_supplicant.conf**:
    - Конфигурационный файл для настройки беспроводной сети.
    - Содержит параметры для подключения к Wi-Fi сети.

10. **userconf**:
    - Файл конфигурации для настройки пользователя.
    - Определяет параметры, связанные с учетной записью пользователя.

Этот репозиторий обеспечивает полную настройку Raspberry Pi Zero 2W для использования в качестве платформы управления БПЛА. Он включает в себя все необходимые конфигурационные файлы и скрипты для оптимизации производительности, обеспечения безопасности и стабильности системы, а также для настройки беспроводной связи и VPN. Репозиторий нацелен на создание надежной и эффективной системы управления, способной работать в различных условиях эксплуатации.

#### Прокси-сервер для MAVLink #mavUDP

Прокси-сервер для MAVLink предназначен для обеспечения передачи команд и данных между различными компонентами системы управления беспилотными летательными аппаратами (БПЛА). В данном случае прокси-сервер реализован с использованием языка C и предназначен для работы на Raspberry Pi Zero 2W. Рассмотрим его основные компоненты и функции. 
Прокси сжимает пакеты управления MAVLink и обеспечивает автономное управление дроном в случае потери сигнала.

##### Основные компоненты

1. **mav.c**:
   - Основной исходный файл программы, реализующий прокси-сервер для MAVLink.
   - **Основные функции**:
     - Чтение данных с серийного порта.
     - Передача данных по UDP.
     - Обработка сообщений MAVLink.
     - Логирование событий.
     - Настройка и управление сигналами.

3. **deploy.sh**:
   - Скрипт для развертывания прокси-сервера на целевом устройстве.
   - **Основные функции**:
     - Остановка текущего сервиса `mavUDP`.
     - Создание необходимых директорий.
     - Обновление системы и установка необходимых пакетов.
     - Копирование исполняемого файла и сервиса systemd на целевое устройство.
     - Настройка и запуск сервиса `mavUDP`.
     - Логирование событий через `journalctl`.

4. **mavlink_dialect.h.in**:
   - Файл шаблона для создания заголовочного файла MAVLink, который определяет используемый диалект MAVLink (например, ardupilotmega).

6. **config.sh**:
   - Скрипт конфигурации, предназначенный для изменения настроек и запуска/остановки скриптов.
   - **Основные функции**:
     - Изменение конфигурации `mediamtx`.
     - Запуск и остановка необходимых скриптов.

7. **mavUDP.service**:
   - Файл конфигурации сервиса systemd для прокси-сервера `mavUDP`.
   - **Основные функции**:
     - Определение параметров запуска и остановки сервиса.
     - Настройка параметров сети и логирования.

##### Как это работает

![[Untitled - Описание работы mavUDP.jpg]]

1. **Чтение и обработка данных с серийного порта**:
   - Программа открывает серийный порт для чтения данных от контроллера полета БПЛА.
   - Настраиваются параметры порта, включая скорость передачи данных и режим работы.

2. **Передача данных по UDP**:
   - Программа создает UDP-сокет для передачи данных на наземную станцию управления (GCS).
   - Настраиваются параметры сети, включая IP-адрес и порт назначения.

3. **Обработка сообщений MAVLink**:
   - Программа читает данные с серийного порта и UDP-сокета.
   - Парсинг и обработка сообщений MAVLink с использованием библиотеки MAVLink.
   - Обработка специфичных сообщений, таких как RC_CHANNELS, RC_CHANNELS_RAW, и HEARTBEAT.

4. **Логирование и управление сигналами**:
   - Программа ведет логирование событий и сообщений с использованием syslog.
   - Настраиваются обработчики сигналов для корректного завершения работы программы при получении сигнала SIGINT или SIGTERM.

5. **Сборка и развертывание**:
   - Проект собирается с использованием CMake.
   - Скрипт deploy.sh выполняет развертывание, установку и настройку прокси-сервера на целевом устройстве.
   - Файл сервиса systemd обеспечивает автоматический запуск и управление прокси-сервером.

Прокси-сервер позволяет надежно передавать команды и данные между контроллером полета БПЛА и наземной станцией управления, обеспечивая стабильную работу системы в различных условиях эксплуатации.

#### Описание работы системы автоматического регулирования скорости сети для беспилотных летательных аппаратов (БПЛА) #modem

Для обеспечения надежной и эффективной передачи данных и управления беспилотными летательными аппаратами (БПЛА) используется комплекс скриптов и конфигурационных файлов, направленных на автоматическое регулирование скорости сетевого соединения. Данная система позволяет адаптировать параметры соединения в зависимости от текущих условий сети, минимизировать задержки и предотвращать переполнения буфера, что критично для стабильной работы БПЛА.

##### Основные компоненты системы

1. **Инициализация и настройка модема**
   Система включает в себя скрипты для инициализации и настройки модемов, подключаемых к устройству через интерфейсы `usb0` и `wg0`. Эти скрипты выполняют настройку параметров модема, таких как скорость передачи данных, параметры подключения и режимы работы, используя команды AT. Инициализация модема также включает настройку сетевых интерфейсов и фильтров трафика, необходимых для корректной работы системы.

2. **Конфигурация и управление скоростью соединения**
   Основной функционал системы заключается в автоматическом регулировании скорости соединения с использованием утилиты `cake-autorate`. Эта утилита позволяет динамически изменять скорость загрузки и выгрузки данных в зависимости от текущих условий сети. Конфигурационные файлы (`config.usb0.sh` и `config.wg0.sh`) содержат параметры для настройки минимальных, базовых и максимальных скоростей, а также критерии для определения нагрузки на соединение и задержек.

3. **Мониторинг и адаптация сети**
   Система постоянно мониторит качество соединения, используя протоколы ping и fping для проверки задержек и потерь пакетов. На основе собранных данных утилита `cake-autorate` регулирует скорость соединения, уменьшая ее при обнаружении задержек и увеличивая при нормальных условиях. Это позволяет избежать переполнения буфера и снизить задержки, обеспечивая более стабильное и предсказуемое соединение.

4. **Интеграция с systemd**
   Для удобства управления и автоматизации запуска система интегрирована с менеджером служб systemd. Файлы сервисов позволяют автоматически запускать необходимые скрипты при старте системы, контролировать их работу и перезапускать в случае сбоев.

5. **Обработка и фильтрация трафика**
   Важной частью системы является настройка очередей и фильтров трафика на сетевых интерфейсах. Это позволяет приоритизировать определенные типы трафика (например, управляющие команды и видеопоток) для обеспечения их надежной доставки даже при высокой нагрузке на сеть.

#### Принципы работы системы

- **Автоматическая адаптация**: Система использует мониторинг в реальном времени для адаптации скорости соединения. Это достигается путем регулярных проверок задержек и потерь пакетов, а также анализа текущей нагрузки на сеть.
- **Гибкость и масштабируемость**: Конфигурационные файлы позволяют настроить систему под различные условия эксплуатации и требования. Можно установить разные параметры для загрузки и выгрузки данных, задать пороговые значения для определения перегрузки сети и задержек.
- **Интеграция и управление**: Благодаря интеграции с systemd, система легко управляется и может быть автоматически запущена и контролируема. Это обеспечивает надежность и удобство эксплуатации, особенно в критически важных приложениях, таких как управление БПЛА.

Схема формирование и маршрутизации сети:

![[Channel - Networks (1).jpg]]
#### Преимущества использования

- **Повышенная надежность связи**: Автоматическая адаптация скорости соединения позволяет минимизировать задержки и предотвращать переполнения буфера, что особенно важно для стабильного управления БПЛА.
- **Улучшенная производительность**: Оптимизация параметров сети в реальном времени обеспечивает максимальную пропускную способность при минимальных задержках, что критично для передачи управляющих команд и телеметрии.
- **Гибкость настроек**: Возможность настройки системы под конкретные условия эксплуатации позволяет использовать ее в различных сценариях, от мониторинга и разведки до спасательных операций.

Таким образом, представленная система автоматического регулирования скорости сети является важным компонентом для обеспечения надежного и эффективного управления беспилотными летательными аппаратами, предоставляя гибкость настроек, высокую производительность и надежность соединения в различных условиях эксплуатации.

В целом, этот репозиторий нужен для настройки модема, создания сетевых соединений, управления формированием и маршрутизацией трафика.
Помимо этого, в этом же репозитории, находится скрипт настройки опенсорс проекта "cake-autorate". Это инструмент, который автоматически настраивает параметры пропускной способности CAKE (Common Applications Kept Enhanced) в зависимости от нагрузки трафика и измерений задержки в одну сторону или времени двойного пинга. Проект разработан для переменных соединений, таких как LTE, Starlink и кабельных модемов, где пропускная способность может колебаться, и, следовательно, требуется динамическая регулировка параметров для оптимального управления трафиком.

CAKE - это алгоритм, который управляет буферизацией данных, отправляемых/принимаемых устройством, таким как маршрутизатор OpenWrt или маршрутизатор Asus Merlin. Он минимизирует задержку ("буферизацию") и улучшает отзывчивость сети, не допуская переполнения очередей данными. Однако CAKE использует статические настройки пропускной способности для управления своими очередями, что может привести к компромиссу при переменной пропускной способности соединения.

Именно в этом контексте вступает "cake-autorate". Он непрерывно измеряет нагрузку и задержку, а затем автоматически регулирует настройки пропускной способности CAKE, чтобы соответствовать текущей ситуации. Это позволяет использовать CAKE на переменных соединениях, обеспечивая при этом оптимальное управление трафиком и минимизируя буферизацию.

1. **Автоматическое регулирование параметров**: cake-autorate непрерывно анализирует трафик и задержку, а затем динамически настраивает пропускную способность CAKE для оптимальной производительности.
    
2. **Минимизация буферизации**: Путем динамической регулировки пропускной способности cake-autorate помогает предотвратить переполнение очередей данных и связанную с ними задержку (буферизацию).
    
3. **Поддержка переменных соединений**: Проект предназначен специально для сетевых соединений с переменной пропускной способностью, таких как LTE, Starlink и кабельные модемы.
    
4. **Открытый исходный код**: cake-autorate является проектом с открытым исходным кодом, что означает, что его код доступен для просмотра, использования и улучшения сообществом разработчиков.

Сake-autorate, позволил обеспечить оптимальное управление сетями на переменных соединениях, минимизируя буферизацию и улучшая отзывчивость сети.

### Описание работы системы передачи видео для беспилотных летательных аппаратов (БПЛА) #media

Для эффективной передачи видео с беспилотных летательных аппаратов (БПЛА) используется комплекс скриптов и конфигурационных файлов, направленных на обеспечение стабильной и качественной трансляции видеопотока. Данная система позволяет захватывать видео с камеры, обрабатывать его и передавать по сети, обеспечивая надежную связь между БПЛА и наземной станцией управления (НСУ).

##### Основные компоненты системы

1. **Захват видео**
   - Система поддерживает два типа камер: CSI камеры и USB камеры. В зависимости от типа камеры, система устанавливает соответствующие программные пакеты (`rpicam-apps` для CSI камер и `ffmpeg` для USB камер), необходимые для захвата и обработки видео.

2. **Обработка и передача видео**
   - Основным компонентом для обработки и передачи видеопотока является `mediamtx`, который используется для приема видеопотока от камеры и передачи его по сети. Конфигурационные файлы (`mediamtx.yml`, `mediamtx.yml.csi`, `mediamtx.yml.usb`) содержат настройки для различных типов камер и сетевых интерфейсов. Эти настройки включают параметры для захвата видео, кодирования и передачи потока по протоколу RTSP.

3. **Сервисная инфраструктура**
   - Система интегрирована с менеджером служб systemd, что позволяет автоматизировать запуск и управление сервисами для передачи видео. Файлы сервисов (`mediamtx.service`, `rotate.service`) обеспечивают автоматический запуск необходимых компонентов при старте системы и мониторинг их состояния.

4. **Автоматическое управление файлами видео**
   - Для управления хранилищем видеозаписей используется скрипт `rotate.sh`. Этот скрипт автоматически удаляет старые или поврежденные файлы, оставляя только последние 12 записей. Это позволяет эффективно управлять доступным дисковым пространством и гарантировать наличие только актуальных видеозаписей.

##### Принципы работы системы

- **Захват и обработка видеопотока**: В зависимости от типа камеры (CSI или USB), система инициализирует соответствующее устройство и начинает захват видеопотока. Для этого используется программное обеспечение `ffmpeg` и `rpicam-apps`.
- **Передача видеопотока**: Захваченный видеопоток передается в `mediamtx`, который кодирует видео и передает его по сети по протоколу RTSP. Это обеспечивает стабильную и высококачественную передачу видео на наземную станцию управления.
- **Автоматизация и управление**: Система использует службы systemd для автоматизации запуска и управления компонентами. Это включает в себя настройку и запуск `mediamtx` для передачи видео, а также `rotate` для управления хранилищем видеозаписей.
- **Мониторинг и ротация файлов**: Скрипт `rotate.sh` периодически проверяет количество и размер файлов видеозаписей в указанной директории. При превышении установленного лимита, старые или поврежденные файлы автоматически удаляются, что позволяет поддерживать актуальность и целостность хранилища видеозаписей.

Система передачи видео для БПЛА, основанная на использовании `mediamtx`, `ffmpeg` и `rpicam-apps`, обеспечивает надежную и качественную передачу видеопотока с беспилотных летательных аппаратов на наземную станцию управления. Автоматизация процессов и гибкость настройки делают эту систему эффективным инструментом для различных приложений, требующих стабильной видеосвязи и надежного управления видеозаписями.

- **Надежная передача видео**: Использование `mediamtx` и протокола RTSP обеспечивает стабильную и качественную передачу видеопотока с минимальной задержкой.
- **Гибкость настройки**: Конфигурационные файлы позволяют адаптировать систему под различные типы камер и условия эксплуатации, что делает ее универсальной для различных сценариев использования.
- **Автоматизация процессов**: Интеграция с systemd обеспечивает автоматический запуск и управление компонентами системы, минимизируя необходимость ручного вмешательства и увеличивая надежность работы.
- **Эффективное управление хранилищем**: Автоматическая ротация видеозаписей позволяет эффективно управлять доступным дисковым пространством, гарантируя наличие только актуальных и целостных файлов.

#### Передача видео с беспилотных летательных аппаратов (БПЛА) с использованием камер с широким углом обзора

Для обеспечения качественной передачи видео с беспилотных летательных аппаратов (БПЛА), особенно при наличии задержек, ключевым элементом является выбор подходящей камеры и настройка системы передачи данных. Камеры с широким углом обзора (120 градусов и больше) оказались наиболее эффективными для таких задач. Они обеспечивают большую область захвата изображения, что важно для "ловли" самолета в кадре и повышает чувствительность системы управления при наличии задержек.

##### Преимущества камер с широким углом обзора

1. **Широкий угол обзора**: Камеры с углом обзора 120 градусов и более позволяют захватывать большую область вокруг БПЛА, что уменьшает вероятность упущения важной информации в кадре. Это особенно важно для точного управления и мониторинга в реальном времени.

2. **Повышенная чувствительность системы управления**: Широкий угол обзора позволяет операторам лучше ориентироваться в пространстве и быстрее реагировать на изменения положения БПЛА, что критично при наличии задержек в передаче данных.

![[Pasted image 20240607100802.png]]

### Тестирование и анализ эффективности

#### Методика тестирования системы

Проведение тестирования системы передачи видео и управления БПЛА в условиях городских территорий, таких как Москва, сталкивается с рядом значительных вызовов. В частности, сложность тестирования обусловлена строгими ограничениями на полеты БПЛА, установленными в мегаполисах. Эти ограничения включают в себя запреты на полеты в определенных зонах, требования к получению специальных разрешений и необходимость соблюдения строгих правил безопасности. Тем не менее, несмотря на все трудности, нам удалось провести несколько успешных тестов системы.

#### Методология тестирования

Для оценки работы системы были проведены полеты БПЛА с использованием разработанной системы передачи видео и управления. Во время этих полетов собирались данные телеметрии и логи полетов в формате .tlog, которые записывались через прокси и на наземной станции. Данные телеметрии передавались с помощью протокола MAVLink, что позволило получить подробную информацию о состоянии и параметрах полета в реальном времени.

#### Анализ данных

Для анализа собранных данных использовался инструмент MAVExplorer, встроенный в программное обеспечение Mission Planner. MAVExplorer позволяет визуализировать и анализировать данные телеметрии, предоставляя широкий спектр возможностей для исследования и интерпретации полетных данных. С его помощью были детально изучены логи полетов, выявлены ключевые показатели эффективности системы и проведен сравнительный анализ различных полетов.

![[Pasted image 20240607104703.png]]

#### Сопоставление данных

После анализа данных телеметрии, результаты были сопоставлены с логами модема, чтобы оценить влияние качества соединения на управление и передачу видео. Для визуализации логов модема и облегчения их анализа был разработан специальный инструмент на языке Python. Этот визуализатор позволил наглядно представить временные ряды данных, выявить закономерности и аномалии, а также определить зависимость между параметрами сети и качеством управления БПЛА.

![[plot.png]]

### Выводы и результаты тестирования

Результаты тестирования показали, что разработанная система способна обеспечивать надежное и качественное управление БПЛА в условиях ограниченного радиочастотного спектра и при наличии задержек в передаче данных. Камеры с широким углом обзора (120 градусов и больше) доказали свою эффективность в повышении чувствительности системы и улучшении контроля за полетом даже при наличии задержек в 20-35 мс, что в значительной степени зависит от качества интернет-соединения на наземной станции управления.

Тестирование продемонстрировало, что оптимизация параметров сети и использование специализированных протоколов для передачи видео позволяют значительно снизить задержки и обеспечить стабильную работу системы. Несмотря на сложности, связанные с проведением полетов в условиях городских территорий, полученные данные и их последующий анализ подтвердили жизнеспособность и эффективность разработанной системы передачи видео и управления БПЛА.

Было установлено, что для передачи видео и мавлинка, запакованного в UDP, затем в WireGuard, требуется канал размером примерно **1.1 мб/c**

В дальнейшем планируется проведение дополнительных тестов в более разнообразных условиях и расширение функциональности системы для повышения ее надежности и производительности.

Также велись полные записи полётов.
![[Pasted image 20240607105140.png]]
![[Pasted image 20240607105014.png]]![[Pasted image 20240607105050.png]]

#### Оптимизация параметров для минимизации задержек и потерь данных

В процессе разработки и тестирования системы передачи видео и управления беспилотными летательными аппаратами (БПЛА) была проведена значительная работа по оптимизации параметров, направленных на минимизацию задержек и потерь данных. Одним из наиболее важных аспектов этой работы стала настройка качества изображения и битрейта передаваемого видеопотока, а также сжатие пакетов телеметрии MAVLink.

##### Уменьшение качества изображения и битрейта

Самым простым и эффективным методом оптимизации было снижение качества передаваемого изображения и уменьшение битрейта. Это позволило существенно снизить нагрузку на сетевое соединение и уменьшить задержки, что критично для стабильного управления БПЛА в реальном времени. В результате тестирования было выявлено, что наиболее эффективным оказался пайплайн для передачи видео с разрешением 386x244 пикселей в черно-белом формате при битрейте около 0.8 Мбит/с.

##### Параметры оптимизированного пайплайна

1. **Разрешение видео**: Снижение разрешения до 386x244 пикселей оказалось достаточным для обеспечения приемлемого качества видео при одновременном снижении объема данных, передаваемых по сети. Такое разрешение позволяет эффективно передавать важную визуальную информацию, необходимую для управления БПЛА, при минимальных задержках.

2. **Черно-белый формат**: Переход к черно-белому видео позволил значительно сократить объем передаваемых данных, так как не требуется передавать информацию о цвете. Это особенно важно при ограниченной пропускной способности канала связи.

3. **Битрейт**: Установление битрейта на уровне 0.8 Мбит/с оказалось оптимальным компромиссом между качеством видео и стабильностью соединения. Такой битрейт позволяет поддерживать стабильное и плавное видео, минимизируя при этом вероятность потерь данных и задержек.

##### Сжатие пакетов телеметрии MAVLink

Помимо оптимизации видеопотока, важной частью работы стала оптимизация передачи телеметрических данных по протоколу MAVLink. Для уменьшения объема передаваемых данных и снижения задержек были применены методы сжатия пакетов MAVLink.

1. **Сжатие данных**: Использование сжатия пакетов MAVLink позволило существенно уменьшить объем данных, передаваемых по сети. Это особенно важно для поддержания стабильного соединения в условиях ограниченной пропускной способности канала.
   
2. **Оптимизация частоты передачи**: Регулирование частоты передачи пакетов MAVLink в зависимости от текущих условий сети и потребностей в данных. Это позволило уменьшить нагрузку на сеть и снизить вероятность потерь пакетов.

3. **Использование специализированных алгоритмов**: Применение специализированных алгоритмов сжатия данных, таких как LZ77 или других адаптивных методов, для обеспечения максимальной эффективности сжатия при минимальной задержке.

#### Преимущества оптимизированного пайплайна

- **Снижение задержек**: Оптимизация параметров видео и сжатие пакетов MAVLink позволили значительно уменьшить задержки в передаче данных, что критично для управления БПЛА в реальном времени.
- **Уменьшение потерь данных**: Понижение битрейта и использование черно-белого видео, а также сжатие пакетов MAVLink, снизили вероятность переполнения буфера и потери данных, обеспечивая более стабильное соединение.
- **Эффективное использование канала связи**: Оптимизация параметров видео и телеметрии позволила максимально эффективно использовать доступную пропускную способность канала связи, улучшив качество управления и мониторинга.

Пайплайн для передачи видео с разрешением 386x244 пикселей в черно-белом формате при битрейте около 0.8 Мбит/с и сжатие пакетов телеметрии MAVLink показали наилучшие результаты в условиях ограниченной пропускной способности сети. Этот подход позволяет обеспечить стабильную и надежную передачу данных, необходимую для эффективного управления беспилотными летательными аппаратами в реальном времени. C задержками около 20мс.

### Основные выводы по результатам работы

В ходе данной работы была разработана система передачи данных для беспилотных летательных аппаратов (БПЛА), превосходящая все существующие на рынке open-source решения. Успешно удалось реализовать комплексную систему, включающую в себя передачу видео, управление и телеметрию с минимальными задержками и потерями данных.

- **Оптимизация передачи видео**: Снижение разрешения до 386x244 пикселей и использование черно-белого формата при битрейте около 0.8 Мбит/с позволили значительно уменьшить задержки и повысить стабильность видеопотока. Это обеспечило высокое качество видеопередачи и улучшило управление БПЛА. (такой пайплайн включается только при низкой скорости, там, где это необходимо)
- **Сжатие пакетов MAVLink**: Применение методов сжатия данных MAVLink и оптимизация частоты их передачи позволили уменьшить объем передаваемых данных, что критично для стабильного соединения. Это обеспечило надежную передачу телеметрии и управляющих команд.
- **Визуализация данных**: Разработанный на Python визуализатор логов модема позволил эффективно анализировать и сопоставлять данные телеметрии с качеством соединения, выявляя закономерности и аномалии.
- **Интеграция и управление**: Использование systemd для автоматического запуска и управления компонентами системы обеспечило надежность и удобство эксплуатации. Автоматизация процессов снизила необходимость ручного вмешательства и повысила общую надежность системы.
- **Практическое тестирование**: Несмотря на сложности, связанные с проведением полетов в условиях городских территорий, удалось провести несколько успешных тестов системы. Анализ данных с помощью MAVExplorer и Mission Planner показал высокую эффективность системы в реальных условиях.

#### Достижения и рекомендации

Система была испытана несколькими чемпионами России по авиамодельному спорту и FPV из авиамодельного клуба МИСиС. Все испытатели отметили высокое качество работы системы, несмотря на наличие задержек, которые, по их мнению, были вполне приемлемыми для стабильного полета. Особое впечатление на испытателей произвела возможность полетов на большие расстояния в пределах зоны покрытия сети, что открывает новые перспективы для использования БПЛА в различных сценариях.

#### Перспективы развития

Разработка системы передачи данных и управления беспилотными летательными аппаратами (БПЛА) открывает значительные перспективы для дальнейшего развития и улучшения. Важно отметить несколько ключевых направлений, которые могут существенно повысить эффективность и функциональность системы.

#### Использование аудиоканала и 2G для передачи управления и телеметрии

Одной из перспективных областей является использование аудиоканала и сети 2G для передачи управляющих команд и телеметрии. Такой подход может быть особенно полезен в условиях, где доступ к более современным сетям ограничен или отсутствует. Однако это требует значительной исследовательской работы и разработки новых алгоритмов для передачи данных по аналоговому аудиоканалу.

Передача аналогового сигнала представляет собой большую сложность из-за необходимости обеспечения устойчивой связи и минимизации искажений. Требуется разработка и тестирование новых методов кодирования и декодирования сигналов, а также оптимизация существующих протоколов для работы в условиях ограниченной пропускной способности сети 2G.

#### Снижение задержек и изменение архитектуры

Для дальнейшего снижения задержек планируется пересмотр текущей архитектуры системы. В частности, предполагается:

1. **Смена архитектуры с клиент-серверной**: Переход на более эффективные схемы передачи данных, возможно, с использованием прямого подключения между БПЛА и наземной станцией, минуя промежуточные серверы. Это позволит уменьшить задержки, связанные с обработкой данных на промежуточных узлах.
    
2. **Оптимизация использования WireGuard**: Изучение возможности отказа от WireGuard или переноса его на наземный роутер для уменьшения задержек, связанных с шифрованием и передачей данных через VPN.
    

#### Интеграция с MissionPlanner и QGroundControl

Еще одним важным направлением развития является более полная интеграция системы с популярными программными решениями для управления БПЛА, такими как MissionPlanner и QGroundControl. В частности, планируется:

1. **Вывод видео и телеметрии в MissionPlanner/QGroundControl**: Интеграция видеопотока LTE и данных телеметрии от модема непосредственно в интерфейс этих программ. Это позволит операторам получать всю необходимую информацию и управлять БПЛА из одного окна, повышая удобство и эффективность работы.
    
2. **Разработка плагинов и расширений**: Создание специализированных плагинов для MissionPlanner и QGroundControl, обеспечивающих поддержку новых функций и улучшенную визуализацию данных.

